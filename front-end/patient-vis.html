<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Patient-Vis </title>
    <link rel="stylesheet" href="./libs/bulma-0.8.0/css/bulma.css" />
    <link rel="stylesheet" type="text/css" href="./libs/dc.js-3.1.8/dc.css" />
    <script src="./libs/d3/d3.js"></script>
    <script src="./libs/crossfilter-1.3.12/crossfilter.js"></script>
    <script src="./libs/dc.js-3.1.8/dc.js"></script>
    <!-- <style>
        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        .column {
            float: left;
            width: 300px;
        }

        .event-filter {
            float: left;
            width: 800px;
            background-color: #eeeeee;
        }

    </style> -->
</head>

<body>
    <section class="section">
        <div class="container">
            <h1 class="title"> Patient-vis </h1>
            <h2 class="subtitle"> <strong>patient-centered</strong> clinical data visualization tool</h2>
        </div>
    </section>
    <section class="section">
        <div class="container">
            <div id="patient-list"> Patient List </div>
            <div id="patient-info"> Patient Information </div>
        </div>
    </section>
    <section class="section">
        <div class="container">

            <nav class="level">
                <div class="level-item has-text-centered">
                    <div class="event-filter" id="patient-timeline"> Event TimeLine <br></div>
                    <div class="event-filter" id="patient-event-category"> Event type <br> </div>
                    <div class="event-filter" id="patient-event-key"> Event sub-type <br> </div>
                    <div class="event-filter" id="patient-event-normal"> Event importance <br> </div>
                </div>
            </nav>
        </div>
    </section>

    <section class="section">
        <div class="container">

            <div class="tile is-ancestor">
                <div class="tile is-3 is-vertical">
                    <div id="patient-vitals0"> Temperature </div>
                    <div id="patient-vitals1"> Heart Rate </div>
                    <div id="patient-vitals2"> Systolic blood pressure </div>
                    <div id="patient-vitals3"> Diastolic blood pressure </div>
                </div>
                <div class="tile is-3 is-vertical">
                    <div id="patient-vitals4"> Mean blood pressure </div>
                    <div id="patient-vitals5"> Respiratory rate </div>
                    <div id="patient-vitals6"> Oxygen saturation </div>
                    <div id="patient-vitals7"> Urine output </div>
                </div>
                <div class="tile is-6 is-vertical">
                    <div id="patient-labs">Labs </div>
                    <!-- <div id="patient-notes"> Notes </div> -->
                </div>
            </div>
        </div>

    </section>

    <script>

        // Possible categories of events
        var categories = ["Vitals", "Other", "Labs"];
        var vitals = ["Temperature", "Heart Rate",
            "Systolic blood pressure", "Diastolic blood pressure",
            "Mean blood pressure", "Respiratory rate",
            "Oxygen saturation", "Urine output"];
        var vitalUnits = ["C", "bpm", "mmHg", "mmHg", "mmHg", "bpm", "%", ""];
        var vitalMins = [36, 60, 90, 60, 80, 12, 80, 0];
        var vitalMaxs = [38, 100, 120, 80, 120, 20, 100, 1000];
        var vitalDefault = [37, 80, 105, 70, 100, 16, 90, 500]; // Default value used in null value.
        // Small deviation added to default to recognize this value.
        var minorDeviation = 0.00001;
        vitalDefault = vitalDefault.map(function (d) {
            return d + minorDeviation;
        })



        // Definition of charts
        // var patientList = dc.dataTable('#dc-data-table');
        var patientTimeLine = dc.barChart('#patient-timeline');
        var patientEventCategory = dc.pieChart('#patient-event-category');
        var patientEventKey = dc.pieChart('#patient-event-key');
        var patientEventNormal = dc.pieChart('#patient-event-normal');


        var patientVitals = vitals.map(function (d, i) {
            // Create a chart for each vital
            return nonzeroMin(dc.lineChart('#patient-vitals' + i));
        });
        var patientLabs = dc.dataTable('#patient-labs');
        // var patientNotes = dc.dataTable('#patient-notes');

        d3.json('test.json').then(function (data) {

            console.log(data);

            /* Here we deal with events */

            // Parse the datetime for events
            var dateFormatSpecifier = '%Y-%m-%d %H:%M:%S UTC';
            var dateFormat = d3.timeFormat(dateFormatSpecifier);
            var dateFormatParser = d3.timeParse(dateFormatSpecifier);

            var events = data.events;
            events.forEach(function (d) {
                d.dd = dateFormatParser(d.chart_time);
                d.hour = d3.timeHour(d.dd);
                d.minute = d3.timeMinute(d.dd);
                d.day = d3.timeDay(d.dd);
            });

            var ndx = crossfilter(events);
            var all = ndx.groupAll();


            /* Patient timeline by hours */

            var hourlyDimension = ndx.dimension(function (d) {
                return d.hour;
            });

            var countByHourCategoryGroup = hourlyDimension.group().reduce(
                function (p, v) {
                    ++p.count;
                    categories.forEach(function (d, i) {
                        if (v.category == d) {
                            p.countByCategory[i] += 1;
                        }
                    })
                    return p;
                },
                function (p, v) {
                    --p.count;
                    categories.forEach(function (d, i) {
                        if (v.category == d) {
                            p.countByCategory[i] -= 1;
                        }
                    })
                    return p;
                },
                function () {
                    return {
                        count: 0,
                        countByCategory: [0, 0, 0]
                    };
                }
            );

            patientTimeLine
                .width(600)
                .height(200)
                .transitionDuration(1000)
                .margins({ top: 0, bottom: 20, left: 40, right: 40 })
                .dimension(hourlyDimension)
                .mouseZoomable(true)

                .x(d3.scaleTime().domain([d3.min(events, function (d) {
                    return d.dd;
                }), d3.max(events, function (d) { return d.dd; })]))
                .round(d3.timeHour.round)
                .alwaysUseRounding(true)
                .xUnits(d3.timeHours)
                .elasticY(true)
                .renderHorizontalGridLines(true)
                .legend(dc.legend().x(700).y(10).itemHeight(13).gap(5))
                .yAxisLabel("Event Count")

                .group(countByHourCategoryGroup, categories[0], function (d) {
                    return d.value.countByCategory[0];
                })
                .stack(countByHourCategoryGroup, categories[1], function (d) {
                    return d.value.countByCategory[1];
                })
                .stack(countByHourCategoryGroup, categories[2], function (d) {
                    return d.value.countByCategory[2];
                })
                .centerBar(true)
                .gap(1);

            /* patient event by categroy */
            var categoryDimension = ndx.dimension(function (d) {
                return d.category;
            });
            var categoryGroup = categoryDimension.group();

            patientEventCategory
                .width(180)
                .height(180)
                .radius(80)
                .dimension(categoryDimension)
                .group(categoryGroup)
                .label(function (d) {
                    console.log(d);
                    return d.category;
                })
                .renderLabel(true)
                .innerRadius(40);

            /* patient event by sub-categroy */
            var keyDimension = ndx.dimension(function (d) {
                return d.key;
            });
            var keyGroup = keyDimension.group();

            patientEventKey
                .width(180)
                .height(180)
                .radius(80)
                .dimension(keyDimension)
                .group(keyGroup)
                .label(function (d) {
                    return d.key;
                })
                .renderLabel(true)
                .innerRadius(40);

            /* patient vitals by if normal of not */
            var normalDimension = ndx.dimension(function (d) {
                if (d.category == "Vitals") {
                    vitalIdx = vitals.findIndex(function (value) { return (value == d.key); });
                    if ((d.value_num > vitalMaxs[vitalIdx]) || (d.value_num < vitalMins[vitalIdx]))
                        return "Abnormal";
                    else
                        return "Normal";
                }
                else
                    return "Other";
            })
            var normalGroup = normalDimension.group();

            patientEventNormal
                .width(180)
                .height(180)
                .radius(80)
                .dimension(normalDimension)
                .group(normalGroup)
                .label(function (d) {
                    return d.key;
                })
                .renderLabel(true)
                .innerRadius(40);


            /* patient vitals by Minutes */
            vitals.forEach(function (d, i) {

                var minuteDimension = ndx.dimension(function (d) {
                    return d.minute;
                });

                var vitalByMinuteGroup = minuteDimension.group().reduce(
                    function (p, v) {
                        if (v.key == d) {
                            p.sum += v.value_num;
                            p.count += 1;
                            p.average = p.sum / p.count;
                        }
                        return p;
                    },
                    function (p, v) {
                        if (v.key == d) {
                            p.sum -= v.value_num;
                            p.count -= 1;
                            if (p.count == 0) {
                                p.average = vitalDefault[i];
                            }
                            else {
                                p.average = p.sum / p.count;
                            }
                        }
                        return p;
                    },
                    function () {
                        return { sum: 0, count: 0, average: vitalDefault[i] };
                    }
                )


                patientVitals[i]

                    .width(300)
                    .height(100)
                    .margins({ top: 10, bottom: 20, left: 40, right: 10 })
                    .dimension(minuteDimension)

                    // .rangeChart(patientTimeLine)
                    .x(d3.scaleTime().domain([d3.min(events, function (d) {
                        return d.dd;
                    }), d3.max(events, function (d) { return d.dd; })]))
                    .y(d3.scaleLinear().domain([vitalMins[i], vitalMaxs[i]]))

                    .renderDataPoints(true)
                    .renderHorizontalGridLines(true)
                    .brushOn(false)
                    .elasticX(true)
                    .elasticY(true)
                    .yAxisPadding((vitalMaxs[i] - vitalMins[i]) / 10)

                    .group(removeNullValue(vitalByMinuteGroup, i))
                    .valueAccessor(function (d) {
                        return d.value.average;
                    })

                patientVitals[i].yAxis().ticks(5);
                patientVitals[i].xAxis().ticks(6);

            });

            /* Patient lab events */
            var timeDimension = ndx.dimension(function (d) {
                return d.dd;
            });
            patientLabs
                .dimension(timeDimension)
                .columns([{
                    label: 'Datetime', format: function (d) {
                        return dateFormat(d.dd);
                    }
                }, {
                    label: 'Measurement', format: function (d) {
                        return d.key;
                    }
                }, {
                    label: 'Value', format: function (d) {
                        return d.value_num;
                    }
                }])
                .sortBy(function (d) {
                    return d.dd;
                })
                .order(d3.ascending)




            console.log("Here");
            dc.renderAll();

        })

        function removeNullValue(group, i) {
            return {
                all: function () {
                    return group.all().filter(function (d) {
                        return d.value.average !== vitalDefault[i];
                    })
                }
            }
        }

        function nonzeroMin(chart) {
            dc.override(chart, 'yAxisMin', function () {
                var min = d3.min(chart.data(), function (layer) {
                    return d3.min(layer.values, function (p) {
                        return p.y + p.y0;
                    });
                });
                return dc.utils.subtract(min, chart.yAxisPadding());
            });
            return chart;
        }
    </script>
</body>